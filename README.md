# Threads Automation

## Назначение проекта
Скрипт автоматизирует публикацию контента в Threads на основе данных из Google Sheets. Решение синхронизирует таблицу с очередью постов и автоматически отправляет их в Threads API, отмечая успешные публикации в таблице. Такой подход позволяет единообразно планировать кампании и избегать ручного копирования контента.

## Архитектура решения
- **Python-скрипт** — точка входа, которая подтягивает данные из Google Sheets, формирует payload и отправляет посты в Threads API. Внутри выделены слои работы с HTTP, бизнес-логика и хранилище.
- **Google Sheets** — источник контента и статусов. Через Google Apps Script таблица предоставляет REST‑эндпоинт для чтения/обновления строк.
- **Threads API** — целевая платформа для публикаций. Скрипт обращается к официальному API Meta, обрабатывает ответы и обновляет таблицу.

## Требования
- Python 3.11+
- Операционная система с доступом к сети Интернет и возможностью устанавливать Python-зависимости

### Зависимости
Список фиксированных зависимостей приведён в файле [`requirements.txt`](requirements.txt).

```bash
pip install -r requirements.txt
```

## Переменные окружения и секреты
| Имя переменной | Описание |
| --- | --- |
| `ID_GOOGLE_TABLE` | Идентификатор Google Sheets c очередью публикаций. |
| `URL_GAS_RAZVERTIVANIA` | URL развёрнутого Google Apps Script Web App, предоставляющего REST-интерфейс к таблице. |
| `GOOGLE_SERVICE_ACCOUNT_JSON` | JSON с учётными данными сервисного аккаунта Google (значение передаётся как строка или путь к файлу). |
| `THREADS_ACCESS_TOKEN` | Токен доступа к Threads API. |
| `LOG_LEVEL` | Уровень логирования (`info`, `debug`, `warning`, `error`). |

Перед запуском создайте файл `.env` (или настройте секреты в CI/CD) и заполните перечисленные переменные.

## Запуск

### Локально
1. Склонируйте репозиторий и перейдите в директорию проекта.
2. Установите зависимости: `pip install -r requirements.txt`.
3. Создайте `.env` или экспортируйте переменные окружения.
4. Выполните команду запуска скрипта, например:
   ```bash
   python src/main.py
   ```
   Скрипт загрузит новые записи, опубликует их в Threads и обновит статусы в таблице.

### Через GitHub Actions
- Создайте workflow с шагами `actions/setup-python`, `pip install -r requirements.txt` и запуском скрипта.
- Секреты (`ID_GOOGLE_TABLE`, `URL_GAS_RAZVERTIVANIA`, `GOOGLE_SERVICE_ACCOUNT_JSON`, `THREADS_ACCESS_TOKEN`) добавьте в GitHub Secrets и считывайте через `env`.
- Для регулярного запуска используйте `on.schedule` (cron). Рекомендуем расписание `*/15 * * * *` для проверки новых публикаций каждые 15 минут без излишней нагрузки.

## Логирование и наблюдаемость
- Логи выводятся в формате JSON со стандартными полями `ts`, `level`, `msg`, `context`.
- Устанавливайте `LOG_LEVEL` в `info` для штатной работы и `debug` при диагностике.
- Для heartbeat предусмотрен лог на уровне `info` при каждом успешном запуске с количеством обработанных постов.
- Ошибки публикуются в `stderr`, при сбое повторные попытки делаются с экспоненциальным бэкоффом.

## Ограничения и рекомендации по частоте запусков
- Threads API имеет квоты на число публикаций и запросов в минуту. Следите за лимитами Meta и не превышайте 60 запросов/минуту.
- Google Apps Script ограничен по времени выполнения (6 минут для бесплатного тарифа) и числу обращений в сутки.
- При большом объёме контента задавайте паузу между публикациями (например, 5–10 секунд) и не запускайте cron чаще, чем раз в 5 минут, чтобы избежать превышения квот.
- Храните токены в секретах и регулярно ротируйте доступы.

