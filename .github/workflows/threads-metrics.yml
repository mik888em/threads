name: Threads Metrics

on:
  schedule:
    - cron: '*/60 * * * *'
  workflow_dispatch:

concurrency:
  group: threads-metrics

permissions:
  actions: write
  contents: read

jobs:
  guard:
    runs-on: ubuntu-latest
    outputs:
      should_continue: ${{ steps.check.outputs.should_continue }}
    steps:
      - name: Проверить активные запуски
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const response = await github.request(
              'GET /repos/{owner}/{repo}/actions/workflows/{workflow_id}/runs',
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'threads-metrics.yml',
                status: 'in_progress',
                per_page: 50,
              }
            );
            const otherRuns = response.data.workflow_runs.filter(
              (run) => run.id !== context.runId
            );
            const shouldContinue = otherRuns.length === 0;
            core.setOutput('should_continue', shouldContinue ? 'true' : 'false');
            if (!shouldContinue) {
              core.notice(`Найдено ${otherRuns.length} активных запусков, отменяем текущий.`);
              await github.request(
                'POST /repos/{owner}/{repo}/actions/runs/{run_id}/cancel',
                {
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  run_id: context.runId,
                }
              );
            }

  run-metrics:
    needs: guard
    if: needs.guard.outputs.should_continue == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 100
    env:
      ID_GOOGLE_TABLE: ${{ secrets.ID_GOOGLE_TABLE }}
      GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
      URL_GAS_RAZVERTIVANIA: ${{ secrets.URL_GAS_RAZVERTIVANIA }}
      PYTHONPATH: src
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run metrics collection
        run: python -m threads_metrics.main run
